#!/bin/bash
#
# Creates a gif using byzanz-record and xrectsel and uploads/stores the scrot.

init() {
  DURATION=$1
  DELAY=1

  beep() {
    paplay /usr/share/sounds/freedesktop/stereo/complete.oga
  }

  notify-send -i plugin-screenshot "scrotshare" "Select region to record."
  # xrectsel from https://github.com/lolilolicon/FFcast2/blob/master/xrectsel.c
  ARGUMENTS=$(xrectsel "--x=%x --y=%y --width=%w --height=%h") || exit -1

  sleep $DELAY

  name=r-$( date +"%s" ).gif

  beep
  byzanz-record --verbose --delay=0 ${ARGUMENTS} --cursor --duration=$DURATION ~/tmp/$name
  beep

  push() {
    if [ "$1" == "push to s.mreq.eu" ]; then
      scp ~/tmp/$name mreq:"screenshots/$name"
      # clipboard
      echo "http://s.mreq.eu/$name" | xclip -sel clip
      # notify
      notify-send -i plugin-screenshot "scrotshare" "Recording URL copied to clipboard."
      # remove from tmp
      rm ~/tmp/$name
    fi
  }
  answer=$( echo -e "push to s.mreq.eu\ndon't push" | rofi -dmenu -i -p '↠ ' ) && push "$answer" "$name"
}

notify-send -i plugin-screenshot "scrotshare" "Set record duration."
duration=$( echo "4" | rofi -dmenu -i -p '↠ ' ) && init $duration
